---
title: Authentication
description: Authentication middleware for securing upload endpoints.
---

# Authentication Middleware

The authentication middleware ensures that all requests to the upload API are properly authenticated and authorized.

## Overview

The middleware validates JWT tokens and implements role-based access control (RBAC) for different upload operations.

## Configuration

```typescript
AUTH_CONFIG = {
    JWT_SECRET: process.env.JWT_SECRET,
    TOKEN_EXPIRY: '24h',
    REFRESH_TOKEN_EXPIRY: '7d',
    ALGORITHMS: ['HS256'],
    ISSUER: 'tusflow-api',
};
```

## Token Format

The JWT token should include the following claims:

```json
{
    "sub": "user_id",
    "iss": "tusflow-api",
    "permissions": ["upload:write", "upload:read"],
    "exp": 1672531200,
    "iat": 1672444800
}
```

## Required Permissions

Different endpoints require different permissions:

```typescript
const REQUIRED_PERMISSIONS = {
    POST: ['upload:write'],
    PATCH: ['upload:write'],
    HEAD: ['upload:read'],
    GET: ['upload:read'],
    DELETE: ['upload:write'],
    OPTIONS: [], // No auth required
};
```

## Usage

Include the token in the Authorization header:

```typescript
headers: {
  'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIs...'
}
```

## Error Handling

The middleware returns standardized error responses:

```typescript
// Missing token
{
  "error": {
    "code": "authentication_required",
    "message": "No authentication token provided"
  }
}

// Invalid token
{
  "error": {
    "code": "invalid_token",
    "message": "Token is invalid or expired"
  }
}

// Insufficient permissions
{
  "error": {
    "code": "insufficient_permissions",
    "message": "Required permission not found"
  }
}
```

## Implementation Details

The middleware performs the following checks:

1. Token presence and format validation
2. JWT signature verification
3. Token expiration check
4. Permission validation
5. Rate limiting integration

### Token Validation

```typescript
async function validateToken(token: string): Promise<DecodedToken> {
    try {
        const decoded = await jwt.verify(token, AUTH_CONFIG.JWT_SECRET, {
            algorithms: AUTH_CONFIG.ALGORITHMS,
            issuer: AUTH_CONFIG.ISSUER,
        });
        return decoded;
    } catch (error) {
        throw new AuthError('Token validation failed');
    }
}
```

### Permission Check

```typescript
function checkPermissions(
    decodedToken: DecodedToken,
    requiredPermissions: string[]
): boolean {
    return requiredPermissions.every((permission) =>
        decodedToken.permissions.includes(permission)
    );
}
```

## Security Best Practices

1. **Token Storage**

    - Store tokens securely using HTTP-only cookies
    - Implement proper token refresh mechanisms
    - Use secure session management

2. **Token Validation**

    - Validate all token claims
    - Check token expiration
    - Verify token signature

3. **Error Handling**

    - Return generic error messages
    - Log detailed errors server-side
    - Implement proper rate limiting

4. **CORS Configuration**
    - Set appropriate CORS headers
    - Validate origin headers
    - Use secure cookie attributes

## Example Implementation

```typescript
import { jwt } from '@tus/server';

export async function authenticate(
    request: Request,
    required: string[]
): Promise<void> {
    const token = extractToken(request);
    if (!token) {
        throw new AuthError('No token provided');
    }

    const decoded = await validateToken(token);
    if (!checkPermissions(decoded, required)) {
        throw new AuthError('Insufficient permissions');
    }

    // Attach user info to request
    request.user = {
        id: decoded.sub,
        permissions: decoded.permissions,
    };
}
```

## Integration with Rate Limiting

The authentication middleware integrates with rate limiting:

```typescript
async function handleRequest(request: Request): Promise<Response> {
    try {
        const token = await authenticate(request);
        const rateLimit = await checkRateLimit(token.sub);

        if (!rateLimit.allowed) {
            throw new RateLimitError();
        }

        return await handleAuthenticatedRequest(request);
    } catch (error) {
        return handleError(error);
    }
}
```

## Testing

Example tests for the authentication middleware:

```typescript
describe('Authentication Middleware', () => {
    it('should validate valid tokens', async () => {
        const token = generateTestToken(['upload:write']);
        const request = new Request('/', {
            headers: { Authorization: `Bearer ${token}` },
        });

        await expect(
            authenticate(request, ['upload:write'])
        ).resolves.not.toThrow();
    });

    it('should reject invalid tokens', async () => {
        const request = new Request('/', {
            headers: { Authorization: 'Bearer invalid' },
        });

        await expect(authenticate(request, ['upload:write'])).rejects.toThrow(
            'Token validation failed'
        );
    });
});
```
